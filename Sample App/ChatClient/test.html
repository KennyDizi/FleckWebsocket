<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script> 	

    <title>Test</title>
    <script>
        var running = true;
        var connected = 0;
        var disconnected = 0;
        var failed = 0;
        var received = 0;
        var sent = 0;

        function addError(msg) {
            $('#errors').append('<li>' + msg + '</li>');
        }

        function go(count) {
            var message = "hi from the test script";
            for (var i = 0; i < count; i++) {
                var ws;
                try {
                    ws = new WebSocket("ws://localhost:8181/test");
                } catch (e) {
                    addError(e);
                }
                

                ws.onmessage = function (evt) {
                    received++;
                    $('#received').html(received);

                    if (evt.data != message) {
                        failed++;
                        $('#failed').html(failed);
                    }
                };

                ws.onopen = function () {
                    connected++;
                    $('#connected').html(connected);

                    var that = this;
                    setInterval(function () {
                        if (running) {
                            try {
                                that.send(message);
                                sent++;
                                $('#sent').html(sent);
                            } catch (e) {
                                addError(e);
                            }
                        }
                    }, 200);
                };

                ws.onclose = function () {
                    disconnected++;
                    $('#disconnected').html(disconnected);
                }
            }
        }

        $(document).ready(function () {

            $('#stop').click(function () {
                running = false;
            });

            $('#create').click(function () {
                var count = parseInt($('#count').val());
                go(count);
            });
        });
    </script>
  
</head>
<body>
<h3>Each added socket sends a message every 0.2 seconds and expects that message to be returned to it unchanged</h3>
<input type="submit" value="Stop" id="stop" /><br />
<p>Create conenctions:</p>
<input type="text" value="10" id="count" />
<input type="submit" value="create" id="create"/>
<p>sockets:</p>
<ul>
    <li>connected: <span id="connected">0</span></li>
    <li>disconnected: <span id="disconnected">0</span></li>
</ul>
<p>messages:</p>
    <ul>
        <li>sent: <span id="sent">0</span></li>
        <li>received :<span id="received">0</span></li>        
        <li>wrong return: <span id="failed">0</span></li>
    </ul>
<p>errors:</p>
<ul id="errors"></ul>
</body>
</html>